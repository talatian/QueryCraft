<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueryCraft</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f4f8 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .example-badge {
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: #475569;
        }

        .example-badge:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        #questionInput {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        #questionInput:focus {
            outline: none;
            border-color: #3b82f6;
        }

        #questionInput:disabled {
            background: #f8fafc;
            cursor: not-allowed;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .keyboard-hint {
            font-size: 0.875rem;
            color: #64748b;
        }

        .kbd {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .btn {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .sql-query-display {
            background: #1e293b;
            color: #10b981;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 1rem;
            color: #475569;
            border-bottom: 1px solid #f1f5f9;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .null-value {
            color: #94a3b8;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>QueryCraft</h1>
            <p>Ask questions in plain English and get SQL results instantly</p>
        </div>

        <!-- Example Questions -->
        <div class="card">
            <div class="card-title">‚ú® Example Questions</div>
            <div class="examples" id="examplesContainer"></div>
        </div>

        <!-- Query Input -->
        <div class="card">
            <div class="input-group">
                <label class="input-label" for="questionInput">Your Question</label>
                <textarea
                    id="questionInput"
                    placeholder="e.g., Show me all orders from last month..."
                ></textarea>
            </div>
            <div class="input-footer">
                <div class="keyboard-hint">
                    Press <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to submit
                </div>
                <button class="btn btn-primary" id="submitBtn">
                    <span id="submitBtnText">Run Query</span>
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div class="alert alert-error hidden" id="errorAlert">
            <span>‚ö†Ô∏è</span>
            <span id="errorMessage"></span>
        </div>

        <!-- SQL Query Display -->
        <div class="card hidden" id="sqlQueryCard">
            <div class="card-title">üíª Generated SQL Query</div>
            <pre class="sql-query-display" id="sqlQueryDisplay"></pre>
        </div>

        <!-- Results Display -->
        <div class="card hidden" id="resultsCard">
            <div class="card-title">üìä Query Results (<span id="rowCount">0</span> rows)</div>
            <div class="table-container" id="resultsTableContainer"></div>
        </div>
    </div>

    <script>
        // Configuration
        const EXAMPLE_QUESTIONS = [
            "How many times has each product been ordered?",
            "How many orders have been placed in total?",
            "How many customers registered each month?",
            "What is the average quantity of products per order?",
            "How many orders were placed for each product category?"
        ];

        // DOM Elements
        const questionInput = document.getElementById('questionInput');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnText = document.getElementById('submitBtnText');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const sqlQueryCard = document.getElementById('sqlQueryCard');
        const sqlQueryDisplay = document.getElementById('sqlQueryDisplay');
        const resultsCard = document.getElementById('resultsCard');
        const resultsTableContainer = document.getElementById('resultsTableContainer');
        const rowCount = document.getElementById('rowCount');
        const examplesContainer = document.getElementById('examplesContainer');

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleElement(element, show) {
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        function setLoadingState(loading) {
            questionInput.disabled = loading;
            submitBtn.disabled = loading;

            if (loading) {
                submitBtnText.innerHTML = '<span class="loading-spinner"></span> Processing...';
            } else {
                submitBtnText.textContent = 'Run Query';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            toggleElement(errorAlert, true);
        }

        function hideError() {
            toggleElement(errorAlert, false);
        }

        function displaySqlQuery(query) {
            sqlQueryDisplay.textContent = query;
            toggleElement(sqlQueryCard, true);
        }

        function displayResults(results) {
            if (!results || !results.rows || results.rows.length === 0) {
                resultsTableContainer.innerHTML = '<div class="empty-state">No results found</div>';
                rowCount.textContent = '0';
                toggleElement(resultsCard, true);
                return;
            }

            rowCount.textContent = results.rows.length;

            let tableHtml = '<table><thead><tr>';

            results.columns.forEach(column => {
                tableHtml += `<th>${escapeHtml(column)}</th>`;
            });

            tableHtml += '</tr></thead><tbody>';

            results.rows.forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => {
                    if (cell === null) {
                        tableHtml += '<td><span class="null-value">null</span></td>';
                    } else {
                        tableHtml += `<td>${escapeHtml(String(cell))}</td>`;
                    }
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            resultsTableContainer.innerHTML = tableHtml;
            toggleElement(resultsCard, true);
        }

        async function handleSubmit() {
            const question = questionInput.value.trim();

            if (!question) {
                return;
            }

            hideError();
            toggleElement(sqlQueryCard, false);
            toggleElement(resultsCard, false);
            setLoadingState(true);

            try {
                const response = await fetch('/api/query/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        question: question
                    })
                });

                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                } else {
                    if (data.sql_query) {
                        displaySqlQuery(data.sql_query);
                    }
                    if (data.result) {
                        displayResults(data.result);
                    }
                }
            } catch (error) {
                showError(`Network error: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function handleExampleClick(example) {
            questionInput.value = example;
            questionInput.focus();
        }

        function init() {
            EXAMPLE_QUESTIONS.forEach(example => {
                const badge = document.createElement('div');
                badge.className = 'example-badge';
                badge.textContent = example;
                badge.addEventListener('click', () => handleExampleClick(example));
                examplesContainer.appendChild(badge);
            });

            submitBtn.addEventListener('click', handleSubmit);

            questionInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmit();
                }
            });

            questionInput.focus();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>